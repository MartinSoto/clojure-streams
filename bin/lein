#!/usr/bin/env bash

COMPOSE_SERVICE=clojure
PROGRAM=lein

cnt_name=$PROGRAM.$$

start_container() {
    compose_project=${PROJECT_DIR:-.}/docker-compose.yml

    task_options=""
    if [ -n "$DOCKER_RUN_OPTS" ]; then
        task_options="$task_options $DOCKER_RUN_OPTS"
    fi
    if echo "$@" | grep -q -E '\<repl\>.* :port +[0-9]+'; then
        repl_port=$(echo "$@" | sed -E 's/.*:port +([0-9]+).*/\1/')
        task_options="$task_options -p $repl_port:$repl_port"
    fi

    docker-compose \
        --file "$compose_project" \
        run \
        --name $cnt_name \
        --rm \
        -e USER_UID=$(id -u) \
        -e USER_GID=$(id -g) \
        -e USER_DIR=$HOME \
        -e USER_NAME=$(whoami) \
        -w $(pwd) \
        $task_options \
        $COMPOSE_SERVICE \
        $PROGRAM "$@"
}

kill_container() {
    docker kill $cnt_name 2> /dev/null
}

trap kill_container EXIT

start_container "$@"
